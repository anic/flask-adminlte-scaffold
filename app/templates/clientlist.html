{% extends "base.html" %}

{% block css %}
<link href="{{ url_for('static', filename='plugins/bootstrap-table/bootstrap-table.min.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='plugins/bootstrap-fileinput/css/fileinput.min.css') }}" media="all"
    rel="stylesheet" type="text/css" />

<style>
    .select,
    #locale {
        width: 100%;
    }

    .like {
        margin-right: 10px;
    }
</style>
{% endblock %}

{% block title %}客户列表{% endblock %}
{% block navbar %}
<section class="content-header">
    <h1>客户列表</h1>
    <ol class="breadcrumb">
        <li><i class="fa fa-dashboard"></i> 当前位置</li>
        <li class="active">客户管理</li>
        <li class="active">客户列表</li>
    </ol>
</section>
{% endblock %}

{% block content %}
<div class="box box-primary">
    <div class="box-header with-border">
        {% include 'message.html' %}
    </div>

    <div class="box-body">
        <div id="toolbar">
            <button id="btnUploadDialog" class="btn btn-primary" data-toggle="modal" data-target="#myModal">
                <i class="fa fa-upload"></i> 更新数据
            </button>
        </div>
        <table id="table" data-toolbar="#toolbar" data-search="true" data-show-refresh="true" data-show-toggle="true"
            data-show-fullscreen="true" data-show-columns="true" data-show-columns-toggle-all="true"
            data-detail-view="false" data-show-export="true" data-click-to-select="true"
            data-detail-formatter="detailFormatter" data-minimum-count-columns="2" data-pagination="true"
            data-id-field="id" data-page-list="[10, 25, 50, 100, all]" data-show-footer="false"
            data-side-pagination="server" data-url="/client" data-response-handler="responseHandler">
        </table>
    </div>
</div>

<div id="myModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">文件上传</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input id="txt_file" name="file" type="file" class="file" data-url="upload">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='plugins/bootstrap-table/bootstrap-table.min.js') }}"></script>
<script src="{{ url_for('static', filename='plugins/bootstrap-table/bootstrap-table-locale-all.min.js') }}"></script>
<script
    src="{{ url_for('static', filename='plugins/bootstrap-table/extensions/export/bootstrap-table-export.min.js') }}"></script>
<script src="{{ url_for('static', filename='plugins/tableExport/tableExport.min.js') }}"></script>

<script src="{{ url_for('static', filename='plugins/jquery-fileupload/js/vendor/jquery.ui.widget.js') }}"></script>
<script src="{{ url_for('static', filename='plugins/jquery-fileupload/js/jquery.iframe-transport.js') }}"></script>
<script src="{{ url_for('static', filename='plugins/jquery-fileupload/js/jquery.fileupload.js') }}"></script>
<script>
    function initPage() {
        slide_value = $(".slider").val() == "" ? 50 : parseInt($(".slider").val());
        $(".slider").slider({
            id: "blue",
            max: 100,
            value: slide_value
        });

        $('.status').bootstrapSwitch();
        $(".status").on("switchChange.bootstrapSwitch", function (event, state) {
            switchStatus($(this).data("id"), state, this);
        });
    }
    function switchStatus(id, status, switchBox) {
        restTemplate("PUT", "/notifies/" + id + "/status/" + status, null, function () {
            $($(switchBox)).bootstrapSwitch("state", status);
        });
    }

    //初始化表格
    var $table = $('#table')
    var $remove = $('#remove')
    var selections = []

    function getIdSelections() {
        return $.map($table.bootstrapTable('getSelections'), function (row) {
            return row.id
        })
    }

    function responseHandler(res) {
        $.each(res.rows, function (i, row) {
            row.state = $.inArray(row.id, selections) !== -1
        })
        return res
    }

    function detailFormatter(index, row) {
        var html = []
        $.each(row, function (key, value) {
            html.push('<p><b>' + key + ':</b> ' + value + '</p>')
        })
        return html.join('')
    }



    function initTable(columns) {
        $table.bootstrapTable('destroy').bootstrapTable({
            height: 550,
            locale: 'zh-CN',
            columns: columns
        })
        $table.on('check.bs.table uncheck.bs.table ' +
            'check-all.bs.table uncheck-all.bs.table',
            function () {
                $remove.prop('disabled', !$table.bootstrapTable('getSelections').length)

                // save your data, here just save the current page
                selections = getIdSelections()
                // push or splice the selections if you want to save all data selections
            })
        $table.on('all.bs.table', function (e, name, args) {
            //console.log(name, args)
        })

    }


    $(function () {
        $.get("./tablemapping", function (result) {
            initTable(result.mapping);
        });

        $('#txt_file').fileupload({
            dataType: 'json',
            done: function (e, data) {
                $.each(data.result.files, function (index, file) {
                    alert(file.name);
                });
            }
        });
    })

</script>
{% endblock %}